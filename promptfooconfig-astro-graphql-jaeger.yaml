# =============================================================================
# Promptfoo - ASTRO GraphQL mit Custom OTEL Provider (Jaeger Tracing)
# =============================================================================
# Verwendet den Custom OtelBedrockProvider für direktes Tracing an Jaeger.
#
# Voraussetzungen:
#   1. Jaeger starten: npm run tracing:start
#   2. Evaluation ausführen: npm run eval:astro-jaeger
#   3. Jaeger UI öffnen: http://localhost:16686
#
# =============================================================================

description: "ASTRO GraphQL Query Generation - Custom OTEL Provider mit Jaeger"

# =============================================================================
# EVALUATION OPTIONS
# =============================================================================
evaluateOptions:
  maxConcurrency: 1  # Sequentiell für bessere Trace-Übersicht
  delay: 1000        # 1s Pause zwischen Requests
  showProgressBar: true
  cache: false       # Cache deaktiviert für vollständiges Tracing

# =============================================================================
# CUSTOM OTEL PROVIDER
# =============================================================================
providers:
  - id: file://scripts/otel-bedrock-provider.js
    label: "Claude 3.5 Sonnet (Jaeger Traced)"
    config:
      modelId: eu.anthropic.claude-opus-4-5-20251101-v1:0
      region: eu-central-1
      otlpEndpoint: http://localhost:4318
      serviceName: promptfoo-vehicle-info
      temperature: 0.1
      maxTokens: 2048

# =============================================================================
# PROMPTS
# =============================================================================
prompts:
  - id: graphql-generator
    label: "GraphQL Query Generator"
    raw: |
      Du bist ein Experte für die MAN Vehicle Information GraphQL API.
      Deine Aufgabe ist es, natürlichsprachliche Anfragen in valide GraphQL-Queries zu übersetzen.

      ## GraphQL Schema (vereinfacht)

      ```graphql
      type Query {
        vehicleConfigurations(filter: VehicleFilter): VehicleConfigurationResult
      }

      input VehicleFilter {
        vehicleId: StringFilter
        vin: StringFilter
        engineType: StringFilter
        engineNumber: StringFilter
        family: StringFilter
        maVersion: StringFilter
        minorMaVersion: StringFilter
        pp: StringFilter
        udfVersion: StringFilter
        changeDate: StringFilter
        custspecVersion: StringFilter
        vdfGenerationDate: StringFilter
        categories: [CategoryFilter]
        and: [VehicleFilter]
        or: [VehicleFilter]
        not: VehicleFilter
      }

      input StringFilter {
        eq: String
        ne: String
        gt: String
        gte: String
        lt: String
        lte: String
        wildcard: String
        oneOf: [String]
        exists: Boolean
      }
      ```

      ## Regeln
      1. Gib NUR die GraphQL-Query zurück, ohne Erklärungen
      2. Verwende die korrekten Filter-Operatoren
      3. Bei "trucks" oder "LKW" verwende family: { eq: "Truck" }

      ## Benutzeranfrage
      {{user_query}}

      ## GraphQL Query

# =============================================================================
# TEST CASES (Subset für Jaeger Demo)
# =============================================================================
tests:
  - description: "Jaeger Test 1: Simple VIN Filter"
    vars:
      user_query: "Show me all vehicles with VIN WMA13FZZ3RM933559"
    assert:
      - type: icontains
        value: "vin"
      - type: icontains
        value: "WMA13FZZ3RM933559"

  - description: "Jaeger Test 2: Family Filter"
    vars:
      user_query: "Zeige mir alle LKWs"
    assert:
      - type: icontains
        value: "family"
      - type: icontains
        value: "Truck"

  - description: "Jaeger Test 3: Complex AND Filter"
    vars:
      user_query: "Find vehicles where family is Truck and maVersion is 19"
    assert:
      - type: icontains
        value: "family"
      - type: icontains
        value: "Truck"
      - type: icontains
        value: "maVersion"
      - type: icontains
        value: "19"

  - description: "Jaeger Test 4: Date Range"
    vars:
      user_query: "Get vehicles changed in 2025"
    assert:
      - type: icontains
        value: "changeDate"
      - type: icontains
        value: "2025"

  - description: "Jaeger Test 5: Wildcard Pattern"
    vars:
      user_query: "Find vehicles with engineType containing LF"
    assert:
      - type: icontains
        value: "engineType"
      - type: icontains
        value: "wildcard"

# =============================================================================
# OUTPUT
# =============================================================================
outputPath: ./astro-graphql-jaeger-results.json
writeLatestResults: true

# =============================================================================
# SHARING
# =============================================================================
sharing:
  apiBaseUrl: http://localhost:3210
  appBaseUrl: http://localhost:3210
